# タスク関連 セキュリティテストシナリオ

## 概要
このテストシナリオでは、タスク関連APIのセキュリティ対策と脆弱性を検証します。認証・認可、入力検証、データ保護などのセキュリティ側面に焦点を当てたテストケースを定義します。

## 前提条件
- テスト環境が構築されている
- テストユーザー（一般ユーザー、ヘルパー、管理者）のアカウントが用意されている
- セキュリティテストツール（OWASP ZAP等）が設定されている

## テストシナリオ

### 1. 認証バイパステスト

#### 1.1 認証なしでのアクセス試行
**テスト内容**:
- すべてのタスク関連APIエンドポイントに対して認証トークンなしでアクセスを試みる
- アクセストークンの有効期限切れでアクセスを試みる
- 無効（改ざんされた）アクセストークンでアクセスを試みる

**期待結果**:
- すべてのケースで401 Unauthorizedエラーが返される
- 認証エラーメッセージに機密情報が含まれていない
- 適切なWWW-Authenticateヘッダーが返される

#### 1.2 アクセストークン漏洩リスク
**テスト内容**:
- アクセストークンがHTTPログに記録されるか確認
- アクセストークンがエラーメッセージに含まれるか確認
- アクセストークンがURLに含まれるか確認

**期待結果**:
- アクセストークンがログや画面に表示されない
- アクセストークンがURLに含まれていない（Authorizationヘッダーのみで送信される）

### 2. 認可（アクセス制御）テスト

#### 2.1 権限昇格試行
**テスト内容**:
- 一般ユーザーが他のユーザーのタスクを更新しようと試みる
  - `PUT /api/v1/tasks/{other_user_task_id}`
- 一般ユーザーが他のユーザーのタスク一覧を取得しようと試みる
  - `GET /api/v1/users/{other_user_id}/tasks`
- 一般ユーザーが管理者専用エンドポイントにアクセスしようと試みる

**期待結果**:
- すべてのケースで403 Forbiddenエラーが返される
- エラーメッセージに機密情報が含まれていない

#### 2.2 水平権限昇格試行
**テスト内容**:
- ヘルパーユーザーが担当外のユーザーのタスク一覧を取得しようと試みる
  - `GET /api/v1/users/{non_assigned_user_id}/tasks`
- ヘルパーユーザーが担当外のユーザーのタスク状態を更新しようと試みる
  - `PUT /api/v1/tasks/{non_assigned_task_id}/status`

**期待結果**:
- 403 Forbiddenエラーが返される
- アクセス制御が適切に機能している

#### 2.3 ロール検証
**テスト内容**:
- タスク作成者がタスクを更新できることを確認
- タスク作成者以外のユーザーがタスクを更新できないことを確認
- 担当ヘルパーがタスク状態を更新できることを確認
- 管理者がすべてのタスクにアクセスできることを確認

**期待結果**:
- 適切なロールベースのアクセス制御が機能している

### 3. 入力検証とサニタイゼーション

#### 3.1 SQLインジェクションテスト
**テスト内容**:
- タスクID、ユーザーIDなどのパラメータにSQLインジェクション文字列を入力
  - 例: `/api/v1/tasks/1;DROP TABLE tasks;`
  - 例: `/api/v1/users/1 OR 1=1/tasks`
- タスク作成・更新時のJSONフィールドにSQLインジェクション文字列を入力

**期待結果**:
- 422 Unprocessable Entityエラーまたは404 Not Foundエラーが返される
- データベースに影響を与えない
- エラーメッセージにDB情報が漏洩していない

#### 3.2 XSSテスト
**テスト内容**:
- タスクのtitle、descriptionなどのフィールドにXSS攻撃用のスクリプトを入力
  - 例: `<script>alert('XSS')</script>` や `javascript:alert('XSS')`
- 保存したデータを取得して、スクリプトがエスケープされているか確認

**期待結果**:
- HTMLタグやJavaScriptがエスケープまたは無害化されている
- フロントエンドでスクリプトが実行されない

#### 3.3 入力値バリデーション
**テスト内容**:
- 異常に長いタイトル（10000文字など）の送信
- 無効な日付形式の送信
- 範囲外の優先度値（例: -1や100）の送信
- 無効なステータス値の送信

**期待結果**:
- 422 Unprocessable Entityエラーが返される
- 適切なバリデーションエラーメッセージが返される
- サーバー側でも適切なバリデーションが行われている

### 4. レート制限テスト

**テスト内容**:
- 短時間に大量のタスク作成リクエストを送信
- 短時間に大量のタスク更新リクエストを送信
- 短時間に大量のタスク一覧取得リクエストを送信

**期待結果**:
- レート制限を超えた場合、429 Too Many Requestsエラーが返される
- Retry-Afterヘッダーが含まれている
- IPベースまたはユーザーベースのレート制限が適切に機能している

### 5. HTTPヘッダーセキュリティ

**テスト内容**:
- レスポンスに含まれるセキュリティヘッダーを確認
  - Content-Security-Policy
  - X-Content-Type-Options
  - X-XSS-Protection
  - X-Frame-Options
  - Strict-Transport-Security

**期待結果**:
- 適切なセキュリティヘッダーが設定されている
- CSP（Content Security Policy）が適切に構成されている

### 6. APIエンドポイント列挙脆弱性

**テスト内容**:
- 仕様にない、または非公開のAPIエンドポイントへのアクセス試行
  - URLの推測によるアクセス試行（例: `/api/v1/tasks/export`など）
  - HTTP METHODの変更（GET→POST、GET→DELETEなど）

**期待結果**:
- 存在しないエンドポイントに対して404 Not Foundが返される
- 許可されていないメソッドに対して405 Method Not Allowedが返される
- 詳細なエラーメッセージがシステム情報を漏洩していない

### 7. 機密情報漏洩テスト

#### 7.1 エラーメッセージのテスト
**テスト内容**:
- 様々なエラー条件を引き起こし、エラーメッセージを検査
  - 不正なIDでの404エラー
  - 不正な入力値での422エラー
  - 認証エラーでの401エラー
  - 権限エラーでの403エラー
  - サーバーエラーでの500エラー

**期待結果**:
- エラーメッセージに機密情報（スタックトレース、DB情報、サーバーパスなど）が含まれていない
- エラーメッセージが適切に一般化されている

#### 7.2 応答ヘッダーのテスト
**テスト内容**:
- レスポンスヘッダーを検査し、機密情報が含まれていないか確認
  - Server
  - X-Powered-By
  - カスタムヘッダー

**期待結果**:
- サーバーソフトウェアのバージョン情報などの機密情報が漏洩していない

### 8. CSRF脆弱性テスト

**テスト内容**:
- 別オリジンからのリクエスト送信をシミュレート
- CSRFトークンが設定されていない状態でのリクエスト送信

**期待結果**:
- CORSが適切に設定されている
- タスク作成・更新・削除などの状態変更APIで、CSRF対策が実装されている

### 9. ファジングテスト

**テスト内容**:
- タスク関連APIに対して自動化されたファジング（不正な入力値の大量生成と送信）を実行
- 各パラメータに対して境界値、特殊文字、長大な入力などをテスト

**期待結果**:
- システムが予期しないエラーや例外をスローしない
- すべての異常入力が適切に処理される
- メモリリークやクラッシュが発生しない

## テスト環境とツール

### 環境設定
- テスト専用の分離環境
- 本番同等の設定（セキュリティ設定を含む）
- テスト用のデータセット

### テストツール
- **OWASP ZAP**: 自動スキャンとペネトレーションテスト
- **Burp Suite**: API呼び出しの傍受と改ざん
- **SQLmap**: SQLインジェクションテスト
- **カスタムスクリプト**: 特定のセキュリティテスト自動化

## レポート形式

テスト結果は以下の構成でレポートを作成します：

1. **概要**: テスト目的とスコープ
2. **テスト環境**: 使用した環境とツールの詳細
3. **脆弱性一覧**: 検出された脆弱性のリスト（重大度順）
4. **詳細分析**: 各脆弱性の詳細な説明、再現手順、影響範囲
5. **修正提案**: 各脆弱性に対する推奨対策
6. **その他の発見事項**: セキュリティ向上のための提案
7. **結論**: 全体的なセキュリティ評価と次のステップ

## セキュリティテストのガイドライン

1. テストはセキュリティチームの監督下で実施する
2. 本番環境に対するテストは避け、テスト環境のみで実施する
3. テストデータのみを使用し、実際のユーザーデータを扱わない
4. 発見された脆弱性は責任ある開示プロセスに従って報告する
5. 攻撃的なテストによるサービス中断を最小限に抑える
