# タスク状態更新APIテストシナリオ

## エンドポイント
`PUT /api/v1/tasks/{task_id}/status`

## 概要
このテストシナリオでは、タスク状態更新APIの機能を検証します。既存のタスクのステータスを更新する機能のテストケースを定義します。

## 前提条件
- テストユーザーが存在している
- テストユーザーに関連するタスクが存在している
- ヘルパーユーザーが存在している
- 管理者ユーザーが存在している
- ユーザー・ヘルパーの割り当て関係が設定されている

## テストケース

### TC-001: 正常系 - ヘルパーがタスクを進行中に更新
**入力**
- リクエストヘッダー: 有効なヘルパーアクセストークン
- URLパラメータ: 担当ユーザーのタスクID
- リクエストボディ:
```json
{
    "status": "in_progress"
}
```

**期待結果**
- ステータスコード: 200 OK
- レスポンスボディ: 更新されたタスク情報
  - status: "in_progress"
  - updated_at: 現在の日時に更新されている

### TC-002: 正常系 - ヘルパーがタスクを完了に更新
**入力**
- リクエストヘッダー: 有効なヘルパーアクセストークン
- URLパラメータ: 担当ユーザーのタスクID（進行中状態）
- リクエストボディ:
```json
{
    "status": "completed"
}
```

**期待結果**
- ステータスコード: 200 OK
- レスポンスボディ: 更新されたタスク情報
  - status: "completed"
  - updated_at: 現在の日時に更新されている

### TC-003: 正常系 - 管理者がタスクのステータスを更新
**入力**
- リクエストヘッダー: 有効な管理者アクセストークン
- URLパラメータ: 任意のタスクID
- リクエストボディ:
```json
{
    "status": "cancelled"
}
```

**期待結果**
- ステータスコード: 200 OK
- レスポンスボディ: 更新されたタスク情報
  - status: "cancelled"

### TC-004: 正常系 - タスク作成者（ユーザー）がタスクをキャンセル
**入力**
- リクエストヘッダー: 有効なユーザーアクセストークン
- URLパラメータ: 自分のタスクのID
- リクエストボディ:
```json
{
    "status": "cancelled"
}
```

**期待結果**
- ステータスコード: 200 OK
- レスポンスボディ: 更新されたタスク情報
  - status: "cancelled"

### TC-005: 異常系 - 無効なステータス値
**入力**
- リクエストヘッダー: 有効なヘルパーアクセストークン
- URLパラメータ: 担当ユーザーのタスクID
- リクエストボディ:
```json
{
    "status": "invalid_status"
}
```

**期待結果**
- ステータスコード: 422 Unprocessable Entity
- エラーメッセージ: ステータス値が無効であることを示すメッセージ

### TC-006: 異常系 - ヘルパーでない一般ユーザーがステータスを更新
**入力**
- リクエストヘッダー: 有効な一般ユーザーアクセストークン（タスク作成者以外）
- URLパラメータ: 他のユーザーのタスクID
- リクエストボディ:
```json
{
    "status": "in_progress"
}
```

**期待結果**
- ステータスコード: 403 Forbidden
- エラーメッセージ: アクセス権限がないことを示すメッセージ

### TC-007: 異常系 - 存在しないタスクID
**入力**
- リクエストヘッダー: 有効なヘルパーアクセストークン
- URLパラメータ: 存在しないタスクID（例: 9999）
- リクエストボディ:
```json
{
    "status": "in_progress"
}
```

**期待結果**
- ステータスコード: 404 Not Found
- エラーメッセージ: タスクが存在しないことを示すメッセージ

### TC-008: 異常系 - ステータスが未設定
**入力**
- リクエストヘッダー: 有効なヘルパーアクセストークン
- URLパラメータ: 担当ユーザーのタスクID
- リクエストボディ:
```json
{
    "other_field": "value"
}
```

**期待結果**
- ステータスコード: 422 Unprocessable Entity
- エラーメッセージ: ステータスが必須であることを示すメッセージ

### TC-009: 異常系 - 非担当ヘルパーがステータスを更新
**入力**
- リクエストヘッダー: 有効なヘルパーアクセストークン（担当外のヘルパー）
- URLパラメータ: 非担当ユーザーのタスクID
- リクエストボディ:
```json
{
    "status": "in_progress"
}
```

**期待結果**
- ステータスコード: 403 Forbidden
- エラーメッセージ: アクセス権限がないことを示すメッセージ

### TC-010: 異常系 - 未認証アクセス
**入力**
- リクエストヘッダー: アクセストークンなし
- URLパラメータ: 有効なタスクID
- リクエストボディ:
```json
{
    "status": "in_progress"
}
```

**期待結果**
- ステータスコード: 401 Unauthorized
- エラーメッセージ: 認証が必要であることを示すメッセージ

## モック設定
- データベースに複数のユーザー、ヘルパー、タスクのレコードを事前に用意
- ユーザー・ヘルパー割り当て関係を設定
- 異なるステータス（requested, in_progress, completed, cancelled）のタスクを含める

## 検証項目
- タスクステータスが正しく更新されること
- ステータス更新時の権限チェックの動作確認
- 有効なステータス値のバリデーション確認
- 不正なステータス遷移の制御（任意の実装による）
- 認証の検証
- 認可（アクセス権限）の検証
- エラーハンドリングの適切さ
